<!DOCTYPE html>
<html>
<head>
    <title>Hasclid Debugger</title>
    <style>
        body { background: #111; color: #0f0; font-family: monospace; padding: 20px; }
        #log { white-space: pre-wrap; }
        .error { color: #f55; }
        .success { color: #5f5; font-weight: bold; }
        .info { color: #88f; }
    </style>
</head>
<body>
    <h1>Hasclid System Diagnostics</h1>
    <div id="log"></div>

    <script type="module">
        // 1. Import the WASI Shim directly from a reliable CDN endpoint
        import { WASI, File, OpenFile, ConsoleStdout } from 'https://cdn.jsdelivr.net/npm/@bjorn3/browser_wasi_shim@0.2.19/dist/index.min.js';

        function log(msg, type = '') {
            const el = document.getElementById('log');
            el.innerHTML += `<span class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</span>\n`;
        }

        async function run() {
            try {
                log("WASI Shim imported successfully.", "success");

                // 2. Fetch File
                log("Fetching Euclid.wasm...");
                const response = await fetch('Euclid.wasm');
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText} (File not found?)`);
                }
                
                const bytes = await response.arrayBuffer();
                log(`Download Complete. Size: ${(bytes.byteLength / 1024 / 1024).toFixed(2)} MB`, "success");

                // 3. Compile
                log("Compiling WebAssembly...");
                // Setup the WASI args/env
                const args = ["Euclid.wasm"];
                const env = [];
                const fds = [
                    new OpenFile(new File([])), // stdin
                    new OpenFile(new File([])), // stdout
                    new OpenFile(new File([])), // stderr
                ];
                
                const wasi = new WASI(args, env, fds);

                const { instance } = await WebAssembly.instantiate(bytes, {
                    "wasi_snapshot_preview1": wasi.wasiImport
                });
                log("Compilation Success.", "success");

                // 4. Run
                log("Starting Engine... (Check Console for Output)");
                
                // Hijack the stdout to print to our HTML log
                // The shim writes to the 'File' object we passed in fds[1]
                // We can wrap the write to intercept it, or just read the buffer after.
                // For a live stream, we can shim the fd directly:
                
                const originalWrite = fds[1].write; // Save original
                const decoder = new TextDecoder();
                
                // Override write to capture output live
                fds[1].write = function(data) {
                    const text = decoder.decode(data);
                    log("STDOUT: " + text, "info");
                    return originalWrite.call(fds[1], data);
                };

                wasi.start(instance);
                log("Process Finished.", "success");

            } catch (e) {
                log("CRITICAL FAILURE: " + e.message, "error");
                console.error(e);
            }
        }

        run();
    </script>
</body>
</html>
