<!DOCTYPE html>
<html>
<head>
    <title>Hasclid Debugger</title>
    <style>
        body { background: #111; color: #0f0; font-family: monospace; padding: 20px; }
        #log { white-space: pre-wrap; }
        .error { color: #f55; }
        .success { color: #5f5; font-weight: bold; }
        .info { color: #88f; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@bjorn3/browser_wasi_shim@0.2.19/dist/browser_wasi_shim.min.js"></script>
</head>
<body>
    <h1>Hasclid System Diagnostics</h1>
    <div id="log"></div>

    <script>
        function log(msg, type = '') {
            const el = document.getElementById('log');
            el.innerHTML += `<span class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</span>\n`;
        }

        async function run() {
            try {
                // 1. Check Shim
                log("Checking WASI Shim...");
                if (typeof browser_wasi_shim === 'undefined') {
                    throw new Error("CRITICAL: browser_wasi_shim failed to load. Check your ad-blocker or internet connection.");
                }
                log("Shim Loaded OK.", "success");

                // 2. Fetch File
                log("Fetching Euclid.wasm...");
                const response = await fetch('Euclid.wasm');
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText} (File not found?)`);
                }
                
                const bytes = await response.arrayBuffer();
                log(`Download Complete. Size: ${(bytes.byteLength / 1024 / 1024).toFixed(2)} MB`, "success");

                // 3. Compile
                log("Compiling WebAssembly...");
                const { instance } = await WebAssembly.instantiate(bytes, {
                    "wasi_snapshot_preview1": new browser_wasi_shim.WASI([], {}, []).wasiImport
                });
                log("Compilation Success.", "success");

                // 4. Run
                log("Starting Engine... (Check Console for Output)");
                
                const fds = [
                    new browser_wasi_shim.File([]), // stdin
                    new browser_wasi_shim.File([]), // stdout
                    new browser_wasi_shim.File([]), // stderr
                ];
                const wasi = new browser_wasi_shim.WASI(["Euclid.wasm"], {}, fds);
                
                const decoder = new TextDecoder();
                fds[1].writeSync = function(iovs) {
                    let text = "";
                    for (const iov of iovs) text += decoder.decode(iov);
                    log("STDOUT: " + text, "info");
                    return iovs.reduce((acc, iov) => acc + iov.byteLength, 0);
                };

                wasi.start(instance);
                log("Process Finished.", "success");

            } catch (e) {
                log("CRITICAL FAILURE: " + e.message, "error");
                console.error(e);
            }
        }

        run();
    </script>
</body>
</html>
