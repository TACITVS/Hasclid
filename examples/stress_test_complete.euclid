-- ============================================================================
-- HASCLID v9.0 COMPREHENSIVE STRESS TEST
-- ============================================================================
-- Purpose: Map the capabilities and limitations of the theorem prover
-- Categories: Equalities, Inequalities, Geometry, Edge Cases, Performance
-- ============================================================================

:verbose

-- ============================================================================
-- SECTION 1: BASIC POLYNOMIAL EQUALITIES (Expected: 100% success)
-- ============================================================================

-- Test 1.1: Simple polynomial equality
-- Expected: PROVED (trivial)
(= (+ (* 2 x) 3) (+ 3 (* x 2)))

-- Test 1.2: Polynomial expansion
-- Expected: PROVED (x+1)^2 = x^2 + 2x + 1
:assume (= y (+ (* x x) (+ (* 2 x) 1)))
(= y (+ (* (+ x 1) (+ x 1)) 0))

:reset

-- Test 1.3: High-degree polynomial
-- Expected: PROVED (x^4 - 1 = (x^2-1)(x^2+1))
:assume (= a (- (^ x 4) 1))
:assume (= b (* (- (^ x 2) 1) (+ (^ x 2) 1)))
(= a b)

:reset

-- Test 1.4: Rational coefficients
-- Expected: PROVED
(= (+ (* (/ 1 2) x) (* (/ 1 2) x)) x)

:reset

-- ============================================================================
-- SECTION 2: GEOMETRIC EQUALITIES (Expected: 95% success)
-- ============================================================================

-- Test 2.1: Pythagorean Theorem (3-4-5 triangle)
-- Expected: PROVED
:point A 0 0
:point B 3 0
:point C 0 4
(= (+ (dist2 A B) (dist2 A C)) (dist2 B C))

:reset

-- Test 2.2: Midpoint property
-- Expected: PROVED
:point A 0 0
:point B 6 0
:point M 3 0
:assume (= (midpoint A B M) 0)
(= (dist2 A M) (dist2 M B))

:reset

-- Test 2.3: Collinearity
-- Expected: PROVED
:point P 0 0
:point Q 1 1
:point R 2 2
(= (collinear P Q R) 0)

:reset

-- Test 2.4: Perpendicularity (coordinate axes)
-- Expected: PROVED
:point O 0 0
:point X 1 0
:point Y 0 1
(= (perpendicular O X O Y) 0)

:reset

-- Test 2.5: Parallel lines (horizontal)
-- Expected: PROVED
:point A 0 0
:point B 1 0
:point C 0 1
:point D 1 1
(= (parallel A B C D) 0)

:reset

-- Test 2.6: Circle constraint
-- Expected: PROVED
:point P 3 4
:point O 0 0
(= (circle P O 5) 0)

:reset

-- ============================================================================
-- SECTION 3: SYMBOLIC PARAMETERS (Expected: Mixed results)
-- ============================================================================

-- Test 3.1: Symbolic distance (concrete result)
-- Expected: PROVED
:point A 0 0
:point B S 0
(= (dist2 A B) (^ S 2))

:reset

-- Test 3.2: Symbolic Pythagorean (scaled triangle)
-- Expected: PROVED
:point A 0 0
:point B S 0
:point C 0 S
(= (+ (dist2 A B) (dist2 A C)) (* 2 (^ S 2)))

:reset

-- Test 3.3: Symbolic midpoint
-- Expected: PROVED
:point A 0 0
:point B (* 2 S) 0
:point M S 0
:assume (= (midpoint A B M) 0)
(= (dist2 A M) (^ S 2))

:reset

-- Test 3.4: The problematic square_3_lines case (simplified)
-- This is KNOWN to hang or fail with GeoSolver
-- Expected: May hang or return unknown
:point A 0 0
:point B S 0
:point C S S
:point D x y
:assume (= (dist2 C D) (^ S 2))
:assume (= (perpendicular B C C D) 0)
-- Don't test the goal yet, just checking if assumptions work
(= (dist2 A A) 0)

:reset

-- ============================================================================
-- SECTION 4: UNIVARIATE INEQUALITIES (Expected: 100% success with Sturm)
-- ============================================================================

-- Test 4.1: Simple positivity (after Gröbner reduction)
-- Expected: Should reduce to univariate and use Sturm
:assume (= y (+ (^ x 2) 1))
(> y 0)

:reset

-- Test 4.2: Polynomial always positive
-- Expected: PROVED (x^2 >= 0 is universally true)
(>= (^ x 2) 0)

:reset

-- Test 4.3: Polynomial with constraint
-- Expected: Depends on reduction
:assume (= x 5)
(> (^ x 2) 20)

:reset

-- ============================================================================
-- SECTION 5: MULTIVARIATE INEQUALITIES (Expected: FAILURE)
-- ============================================================================

-- Test 5.1: Sum of squares (trivial SOS)
-- Expected: PROVED (x^2 + y^2 >= 0 is trivial SOS)
(>= (+ (^ x 2) (^ y 2)) 0)

:reset

-- Test 5.2: Triangle Inequality (THE CLASSIC FAILURE)
-- Expected: FALSE/UNKNOWN (Cannot prove via heuristic)
:point A 0 0
:point B 3 4
:point C 6 0
(>= (+ (dist2 A B) (dist2 B C)) (dist2 A C))

:reset

-- Test 5.3: Cauchy-Schwarz Inequality
-- Expected: FALSE/UNKNOWN (Too complex for heuristic)
:point A 0 0
:point B a b
:point C 0 0
:point D c d
(>= (* (dist2 A B) (dist2 C D)) (^ (dot A B C D) 2))

:reset

-- Test 5.4: Non-trivial SOS (x^2 + xy + y^2 >= 0)
-- Expected: FALSE/UNKNOWN (Not trivial SOS, but is true)
(>= (+ (^ x 2) (+ (* x y) (^ y 2))) 0)

:reset

-- ============================================================================
-- SECTION 6: COMPLEX GEOMETRIC THEOREMS (Expected: 80% success)
-- ============================================================================

-- Test 6.1: Thales' Theorem (midpoint version)
-- Expected: PROVED
:point A 0 0
:point B 4 0
:point M 2 0
:assume (= (midpoint A B M) 0)
(= (* 4 (dist2 A M)) (dist2 A B))

:reset

-- Test 6.2: Apollonius Theorem (median length)
-- Expected: PROVED
:point A 0 0
:point B 6 0
:point C 0 8
:point M 3 0
:assume (= (midpoint A B M) 0)
(= (+ (dist2 C A) (dist2 C B)) (+ (* 2 (dist2 C M)) (* 2 (dist2 A M))))

:reset

-- Test 6.3: Parallelogram diagonal property
-- Expected: PROVED (diagonals bisect each other)
:point A 0 0
:point B 4 0
:point C 5 3
:point D 1 3
:assume (= (parallel A B D C) 0)
:assume (= (parallel A D B C) 0)
-- Diagonals AC and BD bisect at same point M
:point M (/ 5 2) (/ 3 2)
:assume (= (midpoint A C M) 0)
(= (midpoint B D M) 0)

:reset

-- Test 6.4: Rectangle property (perpendicular sides)
-- Expected: PROVED
:point A 0 0
:point B 4 0
:point C 4 3
:point D 0 3
:assume (= (perpendicular A B B C) 0)
:assume (= (perpendicular B C C D) 0)
(= (perpendicular C D D A) 0)

:reset

-- ============================================================================
-- SECTION 7: SOLVER ROUTING TESTS (Test multi-solver system)
-- ============================================================================

-- Test 7.1: Should route to Wu (geometric problem)
-- Expected: Router selects Wu's method
:point A 0 0
:point B 1 0
:point C 0 1
:auto (= (+ (dist2 A B) (dist2 A C)) 2)

:reset

-- Test 7.2: Should route to Gröbner (pure algebraic)
-- Expected: Router selects Gröbner
:assume (= (^ x 2) 1)
:auto (= (* x (* x (* x x))) 1)

:reset

-- Test 7.3: Force Wu explicitly
-- Expected: Wu's method proves it
:assume (= (* x x) 1)
:wu (= (* x (* x (* x x))) 1)

:reset

-- ============================================================================
-- SECTION 8: EDGE CASES AND DEGENERACIES
-- ============================================================================

-- Test 8.1: Degenerate triangle (collinear points)
-- Expected: PROVED (all collinear)
:point A 0 0
:point B 1 0
:point C 2 0
:assume (= (collinear A B C) 0)
(= (collinear B C A) 0)

:reset

-- Test 8.2: Zero distance
-- Expected: PROVED
:point P 5 7
(= (dist2 P P) 0)

:reset

-- Test 8.3: Same point defined twice (different names)
-- Expected: PROVED
:point P 3 4
:point Q 3 4
(= (dist2 P Q) 0)

:reset

-- Test 8.4: Over-constrained system (inconsistent)
-- Expected: Should detect inconsistency
:assume (= x 3)
:assume (= x 5)
(= x 4)

:reset

-- ============================================================================
-- SECTION 9: DETERMINANT TESTS (New feature v9.0)
-- ============================================================================

-- Test 9.1: 2x2 determinant
-- Expected: PROVED (determinant = 2)
(= (det 1 0 0 2) 2)

:reset

-- Test 9.2: Zero row optimization
-- Expected: PROVED (should simplify to 0 before expansion)
(= (det 0 0 1 2) 0)

:reset

-- Test 9.3: Duplicate rows optimization
-- Expected: PROVED (should simplify to 0 before expansion)
(= (det 1 2 1 2) 0)

:reset

-- Test 9.4: 3x3 determinant (computational test)
-- Expected: PROVED
(= (det 1 0 0 0 1 0 0 0 1) 1)

:reset

-- ============================================================================
-- SECTION 10: PERFORMANCE TESTS (High complexity)
-- ============================================================================

-- Test 10.1: Many variables (6 variables)
-- Expected: May be slow but should work
:point A 0 0
:point B a b
:point C c d
:point D e f
-- Simple distance sum
(= (+ (dist2 A B) (dist2 C D)) (+ (+ (^ a 2) (^ b 2)) (+ (^ (- e c) 2) (^ (- f d) 2))))

:reset

-- Test 10.2: High degree polynomial
-- Expected: May be slow
:assume (= (^ x 6) 1)
(= (* x (* x (* x (* x (* x x))))) 1)

:reset

-- Test 10.3: Complex geometric construction
-- Expected: Should work but may be slow
:point O 0 0
:point A 1 0
:point B 0 1
:point C (-1) 0
:point D 0 (-1)
-- All points on unit circle
:assume (= (dist2 O A) 1)
:assume (= (dist2 O B) 1)
:assume (= (dist2 O C) 1)
:assume (= (dist2 O D) 1)
-- Prove they form a square
(= (+ (dist2 A B) (dist2 B C)) (+ (dist2 C D) (dist2 D A)))

:reset

-- ============================================================================
-- SECTION 11: KNOWN LIMITATIONS (Expected: FAILURE)
-- ============================================================================

-- Test 11.1: Angle expression (NOT SUPPORTED)
-- Expected: PARSE ERROR (no angle primitive)
-- Uncomment to test:
-- (= (angle A B C) 90)

-- Test 11.2: Square root (NOT SUPPORTED)
-- Expected: PARSE ERROR or error
-- Uncomment to test:
-- (= (sqrt (dist2 A B)) 5)

-- Test 11.3: Area computation (NOT SUPPORTED DIRECTLY)
-- Expected: No direct primitive
-- Uncomment to test:
-- (= (area A B C) 6)

-- Test 11.4: Quantifier (NOT SUPPORTED)
-- Expected: Cannot express
-- Conceptual: ∃M. (midpoint A B M)

-- ============================================================================
-- SECTION 12: MACRO SYSTEM TESTS
-- ============================================================================

-- Test 12.1: Simple macro
:macro sq x = (^ x 2)
(= (sq 5) 25)

:reset

-- Test 12.2: Nested macro
:macro sq x = (^ x 2)
:macro dist_sq A B = (+ (sq (- (x A) (x B))) (sq (- (y A) (y B))))
:point P 0 0
:point Q 3 4
(= (dist_sq P Q) 25)

:reset

-- Test 12.3: Conditional macro (if statement)
:macro abs x = (if (>= x 0) x (- 0 x))
-- Note: This won't work for proving, just parsing
-- (= (abs (-5)) 5)

:reset

-- ============================================================================
-- SECTION 13: LEMMA SYSTEM TESTS
-- ============================================================================

-- Test 13.1: Define and use lemma
:point A 0 0
:point B 3 0
:lemma (= (dist2 A B) 9)
-- Now it's in the lemma library
:list

:reset

-- ============================================================================
-- END OF STRESS TEST
-- ============================================================================
--
-- Summary of expected results:
-- - Section 1 (Polynomial Equalities): 100% success
-- - Section 2 (Geometric Equalities): 95% success
-- - Section 3 (Symbolic Parameters): 75% success (some may hang/timeout)
-- - Section 4 (Univariate Inequalities): 100% success
-- - Section 5 (Multivariate Inequalities): 0-20% success (major limitation)
-- - Section 6 (Complex Geometry): 80% success
-- - Section 7 (Solver Routing): Should show different solvers
-- - Section 8 (Edge Cases): 90% success
-- - Section 9 (Determinants): 100% success (new feature)
-- - Section 10 (Performance): May be slow but should work
-- - Section 11 (Known Limitations): Expected to fail
-- - Section 12 (Macros): Parsing tests
-- - Section 13 (Lemmas): Library management
--
-- Run with: cabal run prover < stress_test_complete.euclid > stress_test_results.txt 2>&1
-- ============================================================================
