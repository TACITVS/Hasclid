-- ============================================================================
-- MORLEY'S THEOREM - Complete Reverse Proof
-- ============================================================================
-- Strategy: Reverse Construction (Computationally Optimal)
-- 
-- Instead of starting with a generic triangle and finding the center (which 
-- requires solving cubic equations and expensive CAD), we:
-- 1. Start with the Equilateral Triangle PQR (The "Morley Triangle").
-- 2. Construct vertices A and B outwards using the known angle relationships.
-- 3. PROVE that the resulting configuration forces the ray RB to be the 
--    correct angle trisector.
--
-- This avoids all inequalities and roots, reducing the problem to linear 
-- algebra over polynomial rings, which the engine can solve instantly.
-- ============================================================================

:verbose

-- 1. DEFINE CONSTANTS & PARAMETERS
-- ============================================================================
-- s represents sqrt(3)
:assume (= (^ s 2) 3)

-- u, v, w represent tan(alpha), tan(beta), tan(gamma)
-- Constraint: alpha + beta + gamma = 60 degrees.
-- Identity: tan(a+b+c) = (sum t - prod t) / (1 - sum t_i t_j) = sqrt(3)
:assume (= (- (+ u v w) (* u v w)) (* s (- 1 (+ (* u v) (* v w) (* w u)))))


-- 2. FIX THE CENTRAL EQUILATERAL TRIANGLE (P, Q, R)
-- ============================================================================
-- We align Q and R on the x-axis for simplicity.
-- Q = (0,0)
-- R = (1,0)
-- P = (1/2, s/2)  <-- Top vertex of equilateral triangle
:point Q 0 0
:point R 1 0
:point P 1/2 (/ s 2)


-- 3. CONSTRUCT VERTEX A (Above side QR)
-- ============================================================================
-- In the Morley configuration, the triangle AQR sitting on the center has:
-- Base Angle at Q = 60 + beta
-- Base Angle at R = 60 + gamma
--
-- We calculate the exact slopes using tangent addition formulas.

-- Slope Q->A: tan(60 + beta)
-- Formula: (tan60 + tanB) / (1 - tan60*tanB) = (s + v) / (1 - sv)
:macro mQA = (/ (+ s v) (- 1 (* s v)))

-- Slope R->A: tan(180 - (60 + gamma)) = tan(120 - gamma)
-- Formula: (tan120 - tanG) / (1 + tan120*tanG) 
-- Since tan120 = -s: (-s - w) / (1 - sw)
:macro mRA = (/ (- (* -1 s) w) (- 1 (* s w)))

-- Define A as the intersection of these two lines
:point A xA yA
:assume (= yA (* (mQA) xA))       -- Line through Q(0,0)
:assume (= yA (* (mRA) (- xA 1))) -- Line through R(1,0)


-- 4. CONSTRUCT VERTEX B (Above side RP)
-- ============================================================================
-- In the Morley configuration, the triangle BRP sitting on side RP has:
-- Angle at R (relative to RP) = 60 + alpha
-- Angle at P (relative to PR) = 60 + gamma
--
-- Note: We work with absolute slopes relative to the x-axis.
-- Vector R->P is at 120 degrees.
-- Vector R->B is at 120 + (60 + alpha) = 180 + alpha.
-- Slope mRB = tan(180+a) = tan(a) = u.
:macro mRB = u

-- Vector P->R is at 300 degrees (-60).
-- Vector P->B is at 300 - (60 + gamma) = 240 - gamma.
-- Slope mPB = tan(240 - gamma)
-- Formula: (tan240 - w) / (1 + tan240*w). tan240 = s.
:macro mPB = (/ (- s w) (+ 1 (* s w)))

-- Define B as the intersection
:point B xB yB
:assume (= yB (* u (- xB 1)))               -- Line through R(1,0)
:assume (= (- yB (/ s 2)) (* (mPB) (- xB 1/2))) -- Line through P


-- 5. THE FINAL PROOF
-- ============================================================================
-- We have constructed A and B based on the internal equilateral triangle.
-- We must now prove that this matches the geometry of the original triangle ABC.
--
-- Sufficiency Condition:
-- If the constructed points are correct, then the ray RB must be the trisector 
-- of angle B.
-- 
-- 1. We constructed ray RB with slope u = tan(alpha) relative to the horizontal.
-- 2. We need to prove that the angle between side AB and ray RB is exactly beta.
-- 3. This implies Angle(AB) = alpha + beta.
-- 4. Therefore, we prove: Slope(AB) = tan(alpha + beta).

-- Target Slope: tan(a+b) = (u+v) / (1-uv)
-- We check: (yB - yA) / (xB - xA) == (u+v) / (1-uv)
-- Cross-multiplied form to avoid division:

:prove (= (* (- yB yA) (- 1 (* u v))) (* (- xB xA) (+ u v)))