-- Stress Test: Cayley-Menger Determinant
-- Checks if 4 points in 2D are coplanar (Volume=0), which is always true.
-- This involves expanding a 5x5 determinant of squared distances.
-- Stresses macro expansion and polynomial arithmetic.

:verbose
:set-order grevlex

-- 1. Define Determinant Macros
-- 2x2 Determinant: |a b|
--                  |c d|
:macro det2 a b c d = (- (* a d) (* b c))

-- 3x3 Determinant via cofactor expansion along row 1
-- |a1 a2 a3|
-- |b1 b2 b3|
-- |c1 c2 c3|
:macro det3 a1 a2 a3 b1 b2 b3 c1 c2 c3 = (+ (* a1 (det2 b2 b3 c2 c3)) (- (* a2 (det2 b1 b3 c1 c3)) (* a3 (det2 b1 b2 c1 c2))))

-- 4x4 Determinant (Getting big...)
:macro det4 a1 a2 a3 a4 b1 b2 b3 b4 c1 c2 c3 c4 d1 d2 d3 d4 = (+ (- (+ (* a1 (det3 b2 b3 b4 c2 c3 c4 d2 d3 d4)) (* a3 (det3 b1 b2 b4 c1 c2 c4 d1 d2 d4))) (+ (* a2 (det3 b1 b3 b4 c1 c3 c4 d1 d3 d4)) (* a4 (det3 b1 b2 b3 c1 c2 c3 d1 d2 d3)))) 0)
-- Note: Signs are + - + -
-- a1 * det(minor1) - a2 * det(minor2) + a3 * det(minor3) - a4 * det(minor4)
-- Using 0 to fix syntax if needed, but structure above: (+ (- (+) (+)) 0) is messy.
-- Correct logic:
-- T1 = a1 * det3(...)
-- T2 = a2 * det3(...)
-- T3 = a3 * det3(...)
-- T4 = a4 * det3(...)
-- Result = T1 - T2 + T3 - T4

-- Let's use a simpler specific CM matrix structure to avoid writing generic det5?
-- CM Matrix for 4 points P1..P4:
-- 0   1    1    1    1
-- 1   0    d12  d13  d14
-- 1   d21  0    d23  d24
-- 1   d31  d32  0    d34
-- 1   d41  d42  d43  0

-- We can hardcode the expansion of the first row (0 1 1 1 1).
-- CM = 0*M11 - 1*M12 + 1*M13 - 1*M14 + 1*M15
--    = -M12 + M13 - M14 + M15
-- Where M1j are 4x4 minors.

-- Define Distance Shortcuts
:macro d12 = (dist2 P1 P2)
:macro d13 = (dist2 P1 P3)
:macro d14 = (dist2 P1 P4)
:macro d23 = (dist2 P2 P3)
:macro d24 = (dist2 P2 P4)
:macro d34 = (dist2 P3 P4)

-- Minors (Rows 2-5, Cols various)
-- Row 2: 1   0    d12  d13  d14
-- Row 3: 1   d12  0    d23  d24
-- Row 4: 1   d13  d23  0    d34
-- Row 5: 1   d14  d24  d34  0
-- (Using symmetry d_ij = d_ji)

-- Minor 1,2 (Delete Row 1, Col 2)
-- Cols: 1, 3, 4, 5
-- 1 d12 d13 d14
-- 1 0   d23 d24
-- 1 d23 0   d34
-- 1 d24 d34 0
:macro M12 = (det4 1 d12 d13 d14 1 0 d23 d24 1 d23 0 d34 1 d24 d34 0)

-- Minor 1,3 (Delete Row 1, Col 3)
-- Cols: 1, 2, 4, 5
-- 1 0   d13 d14
-- 1 d12 d23 d24
-- 1 d13 0   d34
-- 1 d14 d34 0
:macro M13 = (det4 1 0 d13 d14 1 d12 d23 d24 1 d13 0 d34 1 d14 d34 0)

-- Minor 1,4 (Delete Row 1, Col 4)
-- Cols: 1, 2, 3, 5
-- 1 0   d12 d14
-- 1 d12 0   d24
-- 1 d13 d23 d34
-- 1 d14 d24 0
:macro M14 = (det4 1 0 d12 d14 1 d12 0 d24 1 d13 d23 d34 1 d14 d24 0)

-- Minor 1,5 (Delete Row 1, Col 5)
-- Cols: 1, 2, 3, 4
-- 1 0   d12 d13
-- 1 d12 0   d23
-- 1 d13 d23 0
-- 1 d14 d24 d34
:macro M15 = (det4 1 0 d12 d13 1 d12 0 d23 1 d13 d23 0 1 d14 d24 d34)

-- Cayley-Menger Value
:macro CM_Val = (+ (- (+ (- 0 M12) M13) M14) M15)

-- 2. Define Points
:point P1 0 0
:point P2 1 0
:point P3 0 1
:point P4 x y

-- 3. Prove CM_Val is 0 (Coplanar)
(= CM_Val 0)
