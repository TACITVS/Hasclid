name: Build and Deploy to GitHub Pages

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GHC Wasm
        run: |
          cd /tmp
          curl -L https://gitlab.haskell.org/ghc/ghc-wasm-meta/-/archive/master/ghc-wasm-meta-master.tar.gz | tar xz
          cd ghc-wasm-meta-master
          ./setup.sh
          # FIX: Manually add the path to GITHUB_PATH instead of using the generated script
          echo "$HOME/.ghc-wasm/wasm32-wasi-ghc/bin" >> $GITHUB_PATH

      - name: Compile Hasclid to WASM
        run: |
          # Use the environment (now automatically in PATH)
          # We might still need the env file for other variables, so let's source it just in case
          source $HOME/.ghc-wasm/env
          
          # Debug: Show we have the source
          ls -R src/
          
          # Compile
          wasm32-wasi-ghc -package containers -isrc src/Main.hs -o Euclid.wasm -O2
          
          # Debug: Verify the output exists
          ls -lh Euclid.wasm

      - name: Prepare Website
        run: |
          mkdir public
          
          # Copy the binary
          cp Euclid.wasm public/
          
          # Copy the interface
          cp index.html public/
          
          # Copy the nojekyll file
          touch public/.nojekyll
          
          # Copy theorems (if they exist)
          if [ -d "theorems" ]; then cp -r theorems public/; fi
          
          # Debug: Show final folder structure
          ls -R public/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4