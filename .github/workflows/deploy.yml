name: Build and Deploy to GitHub Pages

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GHC Wasm
        run: |
          cd /tmp
          curl -L https://gitlab.haskell.org/ghc/ghc-wasm-meta/-/archive/master/ghc-wasm-meta-master.tar.gz | tar xz
          cd ghc-wasm-meta-master
          ./setup.sh
          # Add to path for this session
          echo "$HOME/.ghc-wasm/add_to_github_path.sh" >> $GITHUB_ENV

      - name: Compile Hasclid to WASM
        run: |
          # Use the wasm-specific compiler installed above
          source $HOME/.ghc-wasm/env
          # Compile src/Main.hs to Euclid.wasm
          # -no-hs-main allows us to control entry if needed, but standard is fine
          wasm32-wasi-ghc -package containers -isrc src/Main.hs -o Euclid.wasm -O2

      - name: Prepare Website
        run: |
          mkdir public
          cp Euclid.wasm public/
          cp index.html public/
          # Copy theorems if you want to download them
          cp -r theorems public/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4