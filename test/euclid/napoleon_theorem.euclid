-- ============================================================================
-- NAPOLEON'S THEOREM (1825)
-- One of the most beautiful theorems in geometry
-- ============================================================================
--
-- THEOREM: If you construct equilateral triangles on each side of ANY
-- triangle (externally), the centers of these three equilateral triangles
-- themselves form an equilateral triangle.
--
-- DIFFICULTY: 10/10 - Harder than Euler's Four-Square Identity
-- VARIABLES: ~15
-- ATTRIBUTED TO: Napoleon Bonaparte
-- ============================================================================

:verbose
:set-timeout 60

-- ============================================================================
-- SETUP: Define arbitrary triangle ABC
-- ============================================================================

:point A xA yA
:point B xB yB
:point C xC yC

-- ============================================================================
-- CONSTRUCTION: Centers of equilateral triangles
-- ============================================================================
-- We need to construct the centers O1, O2, O3 of equilateral triangles
-- built on sides AB, BC, CA respectively.
--
-- For an equilateral triangle on side PQ:
-- - The center is at distance |PQ|*sqrt(3)/3 from the midpoint
-- - Perpendicular to PQ, in the outward direction
--
-- Algebraic approach: Use the fact that for equilateral triangle,
-- if we rotate a point 60° around the center, we get another vertex.
--
-- We'll use a coordinate-based construction without explicit sqrt(3)
-- ============================================================================

-- CENTER O1: Equilateral triangle on side AB
-- For an equilateral triangle on AB with center O1:
-- The third vertex D1 satisfies:
-- 1. |O1-A| = |O1-B| = |O1-D1| (center equidistant from vertices)
-- 2. |A-D1| = |B-D1| = |A-B| (equilateral)
--
-- We can express O1 as: O1 = (A + B + D1)/3
-- And use the equilateral constraint to find D1

-- Let's use a different approach: parametric construction
-- O1 is at the centroid of the equilateral triangle on AB
-- Using complex number rotation (algebraically):
-- If AB is one side, rotating B-A by 60° around A gives D1
-- Rotation by 60° = (1/2, sqrt(3)/2) = multiply by (1/2 + i*sqrt(3)/2)
-- Algebraically: D1 = A + R60(B-A) where R60 is 60° rotation matrix

-- For simplicity, let's use the constraint-based approach:
-- O1, O2, O3 are defined implicitly by constraints

-- APPROACH: Use symmetry and direct algebraic constraints
-- For the center O1 of equilateral triangle on AB:
-- - Distance from O1 to midpoint of AB is |AB|*sqrt(3)/6
-- - Direction is perpendicular to AB

-- Let's algebraize this by squaring to eliminate sqrt:
-- If M1 = midpoint of AB = ((xA+xB)/2, (yA+yB)/2)
-- Then |O1-M1|² = 3*|AB|²/36 = |AB|²/12
-- And (O1-M1) · (B-A) = 0 (perpendicular)

:point O1 x1 y1
:point O2 x2 y2
:point O3 x3 y3

-- Midpoints
:macro M1x (/ (+ xA xB) 2)
:macro M1y (/ (+ yA yB) 2)
:macro M2x (/ (+ xB xC) 2)
:macro M2y (/ (+ yB yC) 2)
:macro M3x (/ (+ xC xA) 2)
:macro M3y (/ (+ yC yA) 2)

-- Side vectors
:macro ABx (- xB xA)
:macro ABy (- yB yA)
:macro BCx (- xC xB)
:macro BCy (- yC yB)
:macro CAx (- xA xC)
:macro CAy (- yA yC)

-- O1 construction constraints (on side AB):
-- 1. O1-M1 perpendicular to AB: (x1-M1x)*ABx + (y1-M1y)*ABy = 0
:assume (= (+ (* (- x1 M1x) ABx) (* (- y1 M1y) ABy)) 0)

-- 2. Distance: |O1-M1|² = |AB|²/12
-- |AB|² = ABx² + ABy²
-- |O1-M1|² = (x1-M1x)² + (y1-M1y)²
-- Constraint: 12*(x1-M1x)² + 12*(y1-M1y)² = ABx² + ABy²
:assume (= (* 12 (+ (^ (- x1 M1x) 2) (^ (- y1 M1y) 2))) (+ (^ ABx 2) (^ ABy 2)))

-- O2 construction constraints (on side BC):
:assume (= (+ (* (- x2 M2x) BCx) (* (- y2 M2y) BCy)) 0)
:assume (= (* 12 (+ (^ (- x2 M2x) 2) (^ (- y2 M2y) 2))) (+ (^ BCx 2) (^ BCy 2)))

-- O3 construction constraints (on side CA):
:assume (= (+ (* (- x3 M3x) CAx) (* (- y3 M3y) CAy)) 0)
:assume (= (* 12 (+ (^ (- x3 M3x) 2) (^ (- y3 M3y) 2))) (+ (^ CAx 2) (^ CAy 2)))

-- ============================================================================
-- PROOF: The Napoleon triangle O1-O2-O3 is equilateral
-- ============================================================================
-- We need to prove: |O1-O2| = |O2-O3| = |O3-O1|
-- Or equivalently: |O1-O2|² = |O2-O3|² AND |O2-O3|² = |O3-O1|²

-- First equality: |O1-O2|² = |O2-O3|²
:prove (= (+ (^ (- x1 x2) 2) (^ (- y1 y2) 2)) (+ (^ (- x2 x3) 2) (^ (- y2 y3) 2)))
