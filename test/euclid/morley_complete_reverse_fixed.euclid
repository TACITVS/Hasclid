-- ============================================================================
-- MORLEY'S THEOREM - Minimal Variable Formulation (FIXED)
-- ============================================================================
-- Strategy: 
-- 1. Use macros for algebraic expressions (rational functions).
-- 2. Remove all extra parentheses to prevent "Unknown operator" errors.
-- 3. Reduce everything to a single polynomial check in 3 variables (u,v,s).
-- ============================================================================

:verbose
:set-timeout 300

-- 1. DEFINE VARIABLES
-- ============================================================================
-- u = tan(alpha), v = tan(beta), s = sqrt(3)
:point Vars u v s
:assume (= (^ s 2) 3)

-- 2. DEFINE MACROS (Rational Arithmetic)
-- ============================================================================
-- NOTE: Macros are text substitutions. We define them as S-expressions.
-- We must NOT wrap them in parens when using them.

-- Macro: w = tan(60 - (alpha + beta)) derived formula
-- Numerator of w
:macro Nw = (- (* s (- 1 (* u v))) (+ u v))
-- Denominator of w
:macro Dw = (+ (- 1 (* u v)) (* s (+ u v)))

-- ----------------------------------------------------------------------------
-- Vertex A Slopes (QA and RA)
-- ----------------------------------------------------------------------------
-- mQA = (s + v) / (1 - s*v)
:macro N_QA = (+ s v)
:macro D_QA = (- 1 (* s v))

-- mRA = (-s - w) / (1 - s*w) -> substituted with Nw/Dw
:macro N_RA = (- (* -1 (* s Dw)) Nw)
:macro D_RA = (- Dw (* s Nw))

-- ----------------------------------------------------------------------------
-- Vertex A Coordinates
-- ----------------------------------------------------------------------------
-- xA = (N_RA * D_QA) / (N_RA * D_QA - N_QA * D_RA)
:macro Delta_A = (- (* N_RA D_QA) (* N_QA D_RA))
:macro NumX_A = (* N_RA D_QA)

-- yA = (N_QA * N_RA) / Delta_A
:macro NumY_A = (* N_QA N_RA)

-- ----------------------------------------------------------------------------
-- Vertex B Slopes (PB)
-- ----------------------------------------------------------------------------
-- mPB = (s - w) / (1 + s*w) -> substituted with Nw/Dw
:macro N_PB = (- (* s Dw) Nw)
:macro D_PB = (+ Dw (* s Nw))

-- ----------------------------------------------------------------------------
-- Vertex B Coordinates
-- ----------------------------------------------------------------------------
-- B is intersection of y = u(x-1) and line PB through (1/2, s/2).
-- Solving linear system yields these numerator/denominator forms:

-- Delta_B = 2 * (u * D_PB - N_PB)
:macro Delta_B = (* 2 (- (* u D_PB) N_PB))

-- NumX_B = 2*u*D_PB + s*D_PB - N_PB
:macro NumX_B = (+ (+ (* 2 (* u D_PB)) (* s D_PB)) (* -1 N_PB))

-- NumY_B = u * (NumX_B - Delta_B)
:macro NumY_B = (* u (- NumX_B Delta_B))

-- 3. THE FINAL PROOF
-- ============================================================================
-- We verify the slope of AB matches tan(alpha + beta).
-- Equation: (yB - yA)(1 - uv) = (xB - xA)(u + v)
--
-- Substituted with numerators/denominators:
-- (NumY_B/Delta_B - NumY_A/Delta_A) * (1-uv) = (NumX_B/Delta_B - NumX_A/Delta_A) * (u+v)
--
-- Cleared Denominators (multiply by Delta_A * Delta_B):
-- (NumY_B * Delta_A - NumY_A * Delta_B) * (1-uv) = (NumX_B * Delta_A - NumX_A * Delta_B) * (u+v)

:prove (= (* (- (* NumY_B Delta_A) (* NumY_A Delta_B)) (- 1 (* u v))) (* (- (* NumX_B Delta_A) (* NumX_A Delta_B)) (+ u v)))